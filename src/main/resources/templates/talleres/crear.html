<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Programar Taller | SENA</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/png" th:href="@{/img/logo-sena.png}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    
    <style>
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-start; }
        .form-col { flex: 1; }
        .form-col input, .form-col select { width: 100%; }
        @media (max-width: 768px) { .form-row { flex-direction: column; gap: 0; } }
        
        /* Estilos de validación */
        .error-message { color: #dc3545; font-size: 0.85rem; font-weight: 700; display: block; margin-top: 4px; }
        .field-error { border-color: #dc3545 !important; background-color: #fff8f8 !important; }
        .error-client { color: #e74c3c; font-size: 0.85rem; margin-top: 5px; font-weight: 600; display: none; }
    </style>
</head>
<body>
    
    <div th:replace="~{dashboard :: sidebar}"></div>
    
    <div class="main-content">
        <header th:replace="~{dashboard :: header-top}"></header>

        <div class="dashboard-area">
            <div class="form-container" style="margin:0 auto; max-width: 850px;">
                
                <h3 style="text-align: center; margin-bottom: 25px;">Programar Nuevo Taller</h3>
                
                <div th:if="${error}" style="background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;">
                    <span th:text="${error}"></span>
                </div>

                <form id="formTaller" method="POST" th:action="@{/talleres/guardar}" th:object="${taller}" novalidate>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-weight: 700; color: #555;">Nombre del Taller</label>
                        <input type="text" id="nombreTaller" th:field="*{nombreTaller}" class="form-control" 
                               th:classappend="${#fields.hasErrors('nombreTaller')} ? 'field-error'" placeholder="Ej: Habilidades Blandas" required>
                        <span th:if="${#fields.hasErrors('nombreTaller')}" th:errors="*{nombreTaller}" class="error-message"></span>
                        <span id="err-nombreTaller" class="error-client">Este campo es obligatorio.</span>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label style="font-weight: 700; color: #555;">Ficha / Programa</label>
                            <select id="ficha" th:field="*{ficha}" class="form-control" 
                                    th:classappend="${#fields.hasErrors('ficha')} ? 'field-error'" required>
                                <option value="">-- Seleccione Ficha --</option>
                                <option th:each="f : ${listaFichas}" 
                                        th:value="${f.id}" 
                                        th:text="${f.codigo} + ' - ' + ${f.programa} + ' (' + ${f.jornada} + ')'"></option>
                            </select>
                            <span th:if="${#fields.hasErrors('ficha')}" th:errors="*{ficha}" class="error-message"></span>
                            <span id="err-ficha" class="error-client">Debe seleccionar una ficha.</span>
                        </div>
                        <div class="form-col">
                            <label style="font-weight: 700; color: #555;">Profesional a Cargo</label>
                            <select id="profesional" th:field="*{profesional.id}" class="form-control" 
                                    th:classappend="${#fields.hasErrors('profesional')} ? 'field-error'" required>
                                <option value="">-- Seleccione Profesional --</option>
                                <option th:each="p : ${listaProfesionales}" 
                                        th:value="${p.id}" 
                                        th:text="${p.nombre} + ' (' + ${p.rol} + ')'"></option>
                            </select>
                            <span th:if="${#fields.hasErrors('profesional')}" th:errors="*{profesional}" class="error-message"></span>
                            <span id="err-profesional" class="error-client">Debe seleccionar un profesional.</span>
                        </div>
                    </div>

                    <div class="form-row" style="align-items: flex-end;">
                        <div class="form-col" style="flex: 3;">
                            <label style="font-weight: 700; color: #555;">Fecha</label>
                            <input type="date" id="fecha" th:field="*{fecha}" class="form-control" 
                                   th:classappend="${#fields.hasErrors('fecha')} ? 'field-error'" th:min="${minDate}" required>
                            <span th:if="${#fields.hasErrors('fecha')}" th:errors="*{fecha}" class="error-message"></span>
                            <span id="err-fecha" class="error-client">La fecha es obligatoria.</span>
                        </div>
                        
                        <div class="form-col" style="flex: 1;">
                            <label style="font-weight: 700; color: #555;">Cupo</label>
                            <input type="number" id="cupo" th:field="*{cupo}" class="form-control" 
                                   th:classappend="${#fields.hasErrors('cupo')} ? 'field-error'" min="1" required>
                            <span th:if="${#fields.hasErrors('cupo')}" th:errors="*{cupo}" class="error-message"></span>
                            <span id="err-cupo" class="error-client">El cupo es obligatorio.</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label style="font-weight: 700; color: #555;">Hora Inicio (9am - 4pm)</label>
                            <input type="time" id="horaInicio" th:field="*{horaInicio}" class="form-control" 
                                   th:classappend="${#fields.hasErrors('horaInicio')} ? 'field-error'" required data-min="09:00" data-max="16:00">
                            <span th:if="${#fields.hasErrors('horaInicio')}" th:errors="*{horaInicio}" class="error-message"></span>
                            <span id="err-horaInicio" class="error-client"></span> 
                        </div>
                        <div class="form-col">
                            <label style="font-weight: 700; color: #555;">Hora Fin (9am - 4pm)</label>
                            <input type="time" id="horaFin" th:field="*{horaFin}" class="form-control" 
                                   th:classappend="${#fields.hasErrors('horaFin')} ? 'field-error'" required data-min="09:00" data-max="16:00">
                            <span th:if="${#fields.hasErrors('horaFin')}" th:errors="*{horaFin}" class="error-message"></span>
                            <span id="err-horaFin" class="error-client"></span>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn-main btn-create" style="border: none; cursor: pointer; flex: 1; justify-content: center;">
                            Guardar Taller
                        </button>
                        <a th:href="@{/talleres}" class="btn-cancel">Cancelar</a>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('formTaller').addEventListener('submit', function(e) {
            
            let isValid = true;

            function resetInput(id) {
                const input = document.getElementById(id);
                if (input) input.classList.remove('field-error');
                const error = document.getElementById(`err-${id}`);
                if (error) error.style.display = 'none';
            }

            function validarFormulario() {
                isValid = true;
                const campos = ['nombreTaller', 'ficha', 'profesional', 'fecha', 'cupo'];

                campos.forEach(id => {
                    resetInput(id); 
                    const input = document.getElementById(id);
                    const error = document.getElementById(`err-${id}`);

                    if ((input.tagName === 'SELECT' && input.value === '') || 
                        (input.tagName !== 'SELECT' && !input.value.trim())) {
                        error.style.display = 'block';
                        input.classList.add('field-error');
                        isValid = false;
                    }
                });

                // Validación Horaria
                const horaInicio = document.getElementById('horaInicio');
                const horaFin = document.getElementById('horaFin');
                const errInicio = document.getElementById('err-horaInicio');
                const errFin = document.getElementById('err-horaFin');
                const minRange = horaInicio.getAttribute('data-min');
                const maxRange = horaInicio.getAttribute('data-max');

                if (!horaInicio.value) {
                    errInicio.innerText = "La hora de inicio es obligatoria.";
                    errInicio.style.display = 'block';
                    horaInicio.classList.add('field-error');
                    isValid = false;
                }
                if (!horaFin.value) {
                    errFin.innerText = "La hora de fin es obligatoria.";
                    errFin.style.display = 'block';
                    horaFin.classList.add('field-error');
                    isValid = false;
                }
                
                if (horaInicio.value && horaFin.value) {
                    function getMinutes(timeStr) {
                        const parts = timeStr.split(':');
                        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
                    }

                    const start = getMinutes(horaInicio.value);
                    const end = getMinutes(horaFin.value);
                    const minTime = getMinutes(minRange);
                    const maxTime = getMinutes(maxRange); 

                    let horaValida = true;

                    if (start < minTime || start > maxTime) {
                        errInicio.innerText = `El horario debe ser entre ${minRange} AM y 4 PM.`;
                        errInicio.style.display = 'block';
                        horaInicio.classList.add('field-error');
                        horaValida = false;
                    }
                    if (end < minTime || end > maxTime) {
                        errFin.innerText = `El horario debe ser entre ${minRange} AM y 4 PM.`;
                        errFin.style.display = 'block';
                        horaFin.classList.add('field-error');
                        horaValida = false;
                    }

                    if (horaValida && start >= end) {
                        errFin.innerText = "La hora fin debe ser mayor a la hora de inicio.";
                        errFin.style.display = 'block';
                        horaFin.classList.add('field-error');
                        horaValida = false;
                    }
                    if (!horaValida) isValid = false;
                }
                return isValid;
            }

            if (!validarFormulario()) {
                e.preventDefault();
            }
        });
    </script>

</body>
</html>